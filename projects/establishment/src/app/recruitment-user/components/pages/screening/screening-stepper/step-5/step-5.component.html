<div class="w-full px-2 sm:px-4 md:px-8 font-['Source Sans Pro',sans-serif]">
  <div *ngIf="loading" class="flex justify-center items-center h-48">
    <div class="animate-pulse text-gray-600 text-lg">Loading form data...</div>
  </div>

  <div
    *ngIf="!loading && errorMessage"
    class="text-center py-6 text-red-700 bg-red-50 border border-red-200 rounded-lg shadow-sm"
  >
    <p class="font-medium">{{ errorMessage }}</p>
  </div>

  <div *ngIf="!loading && !errorMessage">
    <form [formGroup]="form" (ngSubmit)="submitForm()" class="space-y-8">
      <div
        *ngIf="notes.length"
        class="p-4 bg-indigo-50 border border-indigo-100 rounded-lg shadow-sm"
      >
        <ul class="list-disc list-inside space-y-1 text-sm text-indigo-800">
          <li *ngFor="let note of notes">
            <strong>Note:</strong> {{ note.message }}
          </li>
        </ul>
      </div>

      <div
        *ngIf="
          form.get('mandatorySubheadingsSelected')?.invalid && form.touched
        "
        class="text-red-700 bg-red-50 border border-red-200 p-3 rounded-md text-sm"
      >
        <div *ngIf="form.get('firstMissedMandatory')?.value">
          <strong>Mandatory Field Required:</strong>
          {{ form.get("firstMissedMandatory")?.value }} must be provided.
        </div>
      </div>

      <h5
        *ngIf="heading"
        class="flex items-center gap-2 px-4 py-3 rounded-md bg-gradient-to-r from-indigo-100 to-indigo-50 border border-indigo-200 text-indigo-700 font-semibold shadow-sm"
      >
        <svg
          class="h-5 w-5 text-indigo-500"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
          />
        </svg>
        {{ heading.score_field_title_name }}
      </h5>

      <div *ngFor="let subheading of subheadings; let i = index">
        <div
          class="mt-6 p-6 bg-white rounded-lg border border-gray-200 shadow-sm"
        >
          <h6 class="text-lg font-semibold text-gray-800 mb-4 bg-blue-100 p-2 rounded-md">
            {{ subheading.score_field_title_name }}
          </h6>

          <div
            *ngIf="
              !getParameters(
                subheading.m_rec_score_field_id,
                subheading.a_rec_adv_post_detail_id
              ).length
            "
            class="p-4 text-center text-gray-500 bg-gray-50 rounded-md"
          >
            <p>No parameters available for this section.</p>
          </div>

          <div
            *ngIf="
              getParameters(
                subheading.m_rec_score_field_id,
                subheading.a_rec_adv_post_detail_id
              ).length
            "
            [formArrayName]="getUniqueKey(subheading, i)"
            class="overflow-x-auto rounded-lg border border-gray-200"
          >
            <table class="min-w-full border-collapse">
              <thead class="bg-gray-100 sticky top-0 z-10">
                <tr>
                  <th
                    *ngFor="
                      let param of getParameters(
                        subheading.m_rec_score_field_id,
                        subheading.a_rec_adv_post_detail_id
                      )
                    "
                    class="px-1 py-1 text-left text-xs font-semibold text-gray-600 uppercase border-b border-gray-200"
                  >
                    {{ param.score_field_parameter_name }}
                    <span
                      *ngIf="param.is_mandatory === 'Y'"
                      class="text-red-600"
                      >*</span
                    >
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-100">
                <ng-container
                  *ngFor="
                    let group of getQualifications(getUniqueKey(subheading, i))
                      .controls;
                    let j = index
                  "
                >
                  <tr
                    [formGroupName]="j"
                    [class.hidden]="group.get('is_deleted')?.value"
                    [class.bg-green-200]="
                      getVerificationStatusForRow(group) == '1' ||
                      getVerificationStatusForRow(group) == '8'
                    "
                    [class.bg-red-200]="
                      getVerificationStatusForRow(group) == '2'
                    "
                  >
                    <td
                      *ngFor="
                        let param of getParameters(
                          subheading.m_rec_score_field_id,
                          subheading.a_rec_adv_post_detail_id
                        )
                      "
                      class="px-1 py-2 align-top"
                    >
                      <input
                        type="hidden"
                        [formControlName]="
                          'param_' +
                          param.m_rec_score_field_parameter_new_id +
                          '_id'
                        "
                      />
                      <input
                        type="hidden"
                        formControlName="a_rec_app_score_field_detail_id"
                      />
                      <input type="hidden" formControlName="is_deleted" />

                      <ng-container [ngSwitch]="param.control_type">
                        <textarea
                          *ngSwitchCase="'TR'"
                          [formControlName]="param.score_field_parameter_name"
                          [placeholder]="
                            'Enter ' + param.score_field_parameter_name
                          "
                          rows="3"
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 text-base bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        ></textarea>
                        <input
                          *ngSwitchCase="'DT'"
                          type="date"
                          [formControlName]="param.score_field_parameter_name"
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 text-base bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />

                        <select
                          *ngSwitchCase="'DC'"
                          [formControlName]="param.score_field_parameter_name"
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 text-base bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        >
                          <option value="">
                            Select {{ param.score_field_parameter_name }}
                          </option>
                          <option
                            *ngFor="let option of param.dropdownOptions"
                            [value]="option.data_id"
                          >
                            {{ option.data_name }}
                          </option>
                        </select>

                        <select
                          *ngSwitchCase="'DP'"
                          [formControlName]="param.score_field_parameter_name"
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 text-base bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        >
                          <option [ngValue]="null">
                            Select {{ param.score_field_parameter_name }}
                          </option>
                          <option
                            *ngFor="let option of param.dropdownOptions"
                            [value]="option.data_id"
                          >
                            {{ option.data_name }}
                          </option>
                        </select>
                        <select
                          *ngSwitchCase="'DY'"
                          [formControlName]="param.score_field_parameter_name"
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 text-base bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        >
                          <option [ngValue]="null">
                            Select {{ param.score_field_parameter_name }}
                          </option>
                          <option
                            *ngFor="let option of param.dropdownOptions"
                            [value]="option.data_id"
                          >
                            {{ option.data_name }}
                          </option>
                        </select>
                        <select
                          *ngSwitchCase="'DE'"
                          [formControlName]="param.score_field_parameter_name"
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 text-base bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        >
                          <option [ngValue]="null">
                            Select {{ param.score_field_parameter_name }}
                          </option>
                          <option
                            *ngFor="let option of param.dropdownOptions"
                            [value]="option.data_id"
                          >
                            {{ option.data_name }}
                          </option>
                        </select>
                        <select
                          *ngSwitchCase="'D'"
                          [formControlName]="param.score_field_parameter_name"
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 text-base bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        >
                          <option value="">
                            Select {{ param.score_field_parameter_name }}
                          </option>
                          <option
                            *ngFor="let option of param.dropdownOptions"
                            [value]="option.data_id"
                          >
                            {{ option.data_name }}
                          </option>
                        </select>

                        <ng-container *ngSwitchCase="'A'">
                          <a
                            *ngIf="
                              !group.get(param.score_field_parameter_name)
                                ?.value &&
                              getFilePath(
                                getUniqueKey(subheading, i),
                                param.m_rec_score_field_parameter_new_id,
                                j
                              ) as filePath
                            "
                            [href]="sanitizeFileUrl(filePath)"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-xs !text-green-600 hover:underline flex items-center mt-1"
                          >
                            <svg
                              class="h-4 w-4 mr-1"
                              fill="none"
                              viewBox="0 0 24 24"
                              stroke="currentColor"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                              />
                            </svg>
                            View Uploaded File
                          </a>

                          <div
                            *ngIf="
                              !group.get(param.score_field_parameter_name)
                                ?.value &&
                              !getFilePath(
                                getUniqueKey(subheading, i),
                                param.m_rec_score_field_parameter_new_id,
                                j
                              )
                            "
                            class="text-xs text-red-600 mt-1 block"
                          >
                            File not uploaded
                          </div>

                          <div
                            *ngIf="
                              group.get(param.score_field_parameter_name)
                                ?.value as newFile
                            "
                            class="mt-2 text-xs text-green-700 flex items-center"
                          >
                            <svg
                              class="h-4 w-4 mr-1"
                              fill="none"
                              viewBox="0 0 24 24"
                              stroke="currentColor"
                            >
                              <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                              />
                            </svg>
                            {{ newFile.name }}
                          </div>
                        </ng-container>
                        <input
                          *ngSwitchDefault
                          [type]="
                            param.isDatatype === 'number' ? 'number' : 'text'
                          "
                          [formControlName]="param.score_field_parameter_name"
                          [placeholder]="
                            'Enter ' + param.score_field_parameter_name
                          "
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 text-base bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />
                      </ng-container>

                      <div
                        *ngIf="
                          group.get(param.score_field_parameter_name)
                            ?.touched &&
                          group.get(param.score_field_parameter_name)?.invalid
                        "
                        class="text-red-600 text-xs mt-1"
                      >
                        <div
                          *ngIf="
                            group
                              .get(param.score_field_parameter_name)
                              ?.hasError('required')
                          "
                        >
                          This field is required.
                        </div>
                        <div
                          *ngIf="
                            group
                              .get(param.score_field_parameter_name)
                              ?.hasError('pattern')
                          "
                        >
                          Only alphabetic characters and () are allowed.
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-container>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
