<div class="w-full px-2 sm:px-4 md:px-8 font-['Source Sans Pro',sans-serif]">
  <div *ngIf="loading" class="flex justify-center items-center h-48">
    <div class="animate-pulse text-gray-600 text-lg">Loading form data...</div>
  </div>

  <div
    *ngIf="!loading && errorMessage"
    class="text-center py-6 text-red-700 bg-red-50 border border-red-200 rounded-lg shadow-sm"
  >
    <p class="font-medium">{{ errorMessage }}</p>
  </div>

  <div *ngIf="!loading && !errorMessage">
    <form [formGroup]="form" (ngSubmit)="submitForm()" class="space-y-3">
      <div
        *ngIf="notes.length"
        class="p-4 bg-indigo-50 border border-indigo-100 rounded-lg shadow-sm"
      >
        <ul class="list-disc list-inside space-y-1 text-sm text-indigo-800">
          <li *ngFor="let note of notes">
            <strong>Note:</strong> {{ note.message }}
          </li>
        </ul>
      </div>

      <div
        *ngIf="
          form.get('mandatorySubheadingsSelected')?.invalid &&
          form.get('mandatorySubheadingsSelected')?.touched
        "
        class="text-red-700 bg-red-50 border border-red-200 p-3 rounded-md text-sm"
      >
        <strong>Mandatory Field Required:</strong>
        {{ form.get("firstMissedMandatory")?.value }} must be provided.
      </div>

      <h5
        class="flex items-center gap-2 px-4 py-3 rounded-md bg-gradient-to-r from-indigo-100 to-indigo-50 border border-indigo-200 text-indigo-700 font-semibold shadow-sm"
      >
        <svg
          class="h-5 w-5 text-indigo-500"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 14l9-5-9-5-9 5 9 5zM12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"
          />
        </svg>
        {{
          heading?.score_field_title_name
        }}
      </h5>

      <div *ngFor="let subheading of subheadings; let i = index">
        <div
          class="p-2 rounded-xl shadow-md border transition-all duration-200"
          [class.bg-green-200]="
            getVerificationStatus(subheading, i) == '1' ||
            getVerificationStatus(subheading, i) == '8'
          "
          [class.border-green-300]="
            getVerificationStatus(subheading, i) == '1' ||
            getVerificationStatus(subheading, i) == '8'
          "
          [class.bg-red-200]="getVerificationStatus(subheading, i) == '2'"
          [class.border-red-300]="getVerificationStatus(subheading, i) == '2'"
          [class.bg-white]="
            getVerificationStatus(subheading, i) != '1' &&
            getVerificationStatus(subheading, i) != '8' &&
            getVerificationStatus(subheading, i) != '2'
          "
          [class.border-gray-200]="
            getVerificationStatus(subheading, i) != '1' &&
            getVerificationStatus(subheading, i) != '8' &&
            getVerificationStatus(subheading, i) != '2'
          "
        >
          <div class="flex items-center justify-between mb-1">
            <label class="flex items-center gap-1 text-gray-700 font-medium">
              <input
                type="checkbox"
                [formControlName]="
                  'is' + getUniqueKey(subheading, i) + 'Selected'
                "
                class="w-4 h-4 accent-indigo-600 border-gray-300 rounded focus:ring-indigo-500"
              />
              {{ subheading.score_field_title_name }}
              <span
                *ngIf="subheading.score_field_is_mandatory === '1'"
                class="text-red-600"
                >*</span
              >
            </label>
          </div>

          <div
            *ngIf="
              !getParameters(
                subheading.m_rec_score_field_id,
                subheading.a_rec_adv_post_detail_id
              ).length
            "
            class="text-center py-4 text-gray-600 italic"
          >
            No parameters available for this section.
          </div>

          <div
            *ngIf="
              getParameters(
                subheading.m_rec_score_field_id,
                subheading.a_rec_adv_post_detail_id
              ).length
            "
            [formArrayName]="'qualifications' + getUniqueKey(subheading, i)"
            class="overflow-x-auto rounded-lg border border-gray-100"
          >
            <table class="min-w-full border-collapse">
              <thead class="bg-gray-100 sticky top-0 z-10">
                <tr>
                  <th
                    *ngFor="
                      let param of getParameters(
                        subheading.m_rec_score_field_id,
                        subheading.a_rec_adv_post_detail_id
                      )
                    "
                    class="px-1 py-1 text-left text-xs font-semibold text-gray-600 uppercase border-b border-gray-200"
                  >
                    {{ param.score_field_parameter_name }}
                    <span
                      *ngIf="
                        form.get(
                          'is' + getUniqueKey(subheading, i) + 'Selected'
                        )?.value && param.is_mandatory === 'Y'
                      "
                      class="text-red-600"
                      >*</span
                    >
                  </th>
                </tr>
              </thead>

              <tbody class="bg-white divide-y divide-gray-100">
                <tr
                  *ngFor="
                    let group of getQualifications(getUniqueKey(subheading, i))
                      .controls;
                    let j = index
                  "
                  [formGroupName]="j"
                  class="hover:bg-gray-50"
                >
                  <td
                    *ngFor="
                      let param of getParameters(
                        subheading.m_rec_score_field_id,
                        subheading.a_rec_adv_post_detail_id
                      )
                    "
                    class="px-1 py-1 align-top max-w-[100px]"
                  >
                    <input
                      type="hidden"
                      formControlName="a_rec_app_score_field_detail_id"
                    />
                    <input
                      type="hidden"
                      [formControlName]="
                        'param_' +
                        param.m_rec_score_field_parameter_new_id +
                        '_id'
                      "
                    />

                    <ng-container
                      *ngIf="
                        param.isDatatype === 'attachment';
                        else controlTypeSwitch
                      "
                    >
                      <ng-container
                        *ngIf="
                          !group.get(param.score_field_parameter_name)?.value &&
                            getFilePath(
                              getUniqueKey(subheading, i),
                              param.m_rec_score_field_parameter_new_id,
                              j
                            ) as filePath;
                          else fileNotUploaded1
                        "
                      >
                        <a
                          [href]="sanitizeFileUrl(filePath)"
                          target="_blank"
                          rel="noopener noreferrer"
                          class="text-xs text-green-700 hover:underline flex items-center"
                        >
                          <svg
                            class="h-4 w-4 mr-1"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                          >
                            <path
                              stroke-linecap="round"
                              stroke-linejoin="round"
                              stroke-width="2"
                              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                            />
                          </svg>
                          View Uploaded File
                        </a>
                      </ng-container>
                      <ng-template #fileNotUploaded1>
                        <span class="text-xs text-red-600"
                          >File not uploaded</span
                        >
                      </ng-template>
                    </ng-container>

                    <ng-template #controlTypeSwitch>
                      <ng-container [ngSwitch]="param.control_type">
                        <textarea
                          *ngSwitchCase="'TR'"
                          [formControlName]="param.score_field_parameter_name"
                          [placeholder]="
                            'Enter ' + param.score_field_parameter_name
                          "
                          rows="3"
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 text-base bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        ></textarea>

                        <input
                          *ngSwitchCase="'T'"
                          [type]="
                            param.isDatatype === 'number' ? 'number' : 'text'
                          "
                          [formControlName]="param.score_field_parameter_name"
                          [placeholder]="
                            'Enter ' + param.score_field_parameter_name
                          "
                          [attr.min]="param.isDatatype === 'number' ? 0 : null"
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 text-base bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />

                        <select
                          *ngSwitchCase="'DC'"
                          [formControlName]="param.score_field_parameter_name"
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 bg-white focus:ring-2 focus:ring-indigo-500"
                        >
                          <option value="">
                            Select {{ param.score_field_parameter_name }}
                          </option>
                          <option
                            *ngFor="let option of param.dropdownOptions"
                            [value]="option.data_id"
                          >
                            {{ option.data_name }}
                          </option>
                        </select>

                        <select
                          *ngSwitchCase="'D'"
                          [formControlName]="param.score_field_parameter_name"
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 bg-white focus:ring-2 focus:ring-indigo-500"
                        >
                          <option value="">
                            Select {{ param.score_field_parameter_name }}
                          </option>
                          <option
                            *ngFor="let option of param.dropdownOptions"
                            [value]="option.data_id"
                          >
                            {{ option.data_name }}
                          </option>
                        </select>

                        <select
                          *ngSwitchCase="'DY'"
                          [formControlName]="param.score_field_parameter_name"
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 bg-white focus:ring-2 focus:ring-indigo-500"
                        >
                          <option value="">Select Year</option>
                          <option
                            *ngFor="let option of param.dropdownOptions"
                            [value]="option.data_id"
                          >
                            {{ option.data_name }}
                          </option>
                        </select>

                        <ng-container *ngSwitchCase="'A'">
                          <ng-container
                            *ngIf="
                              !group.get(param.score_field_parameter_name)
                                ?.value &&
                                getFilePath(
                                  getUniqueKey(subheading, i),
                                  param.m_rec_score_field_parameter_new_id,
                                  j
                                ) as filePath;
                              else fileNotUploaded2
                            "
                          >
                            <a
                              [href]="sanitizeFileUrl(filePath)"
                              target="_blank"
                              rel="noopener noreferrer"
                              class="text-xs text-green-700 hover:underline flex items-center"
                            >
                              <svg
                                class="h-4 w-4 mr-1"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                              >
                                <path
                                  stroke-linecap="round"
                                  stroke-linejoin="round"
                                  stroke-width="2"
                                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                                />
                              </svg>
                              View Uploaded File
                            </a>
                          </ng-container>
                          <ng-template #fileNotUploaded2>
                            <span class="text-xs text-red-600"
                              >File not uploaded</span
                            >
                          </ng-template>
                        </ng-container>

                        <input
                          *ngSwitchDefault
                          [type]="
                            param.isDatatype === 'number' ? 'number' : 'text'
                          "
                          [min]="param.isDatatype === 'number' ? 0 : null"
                          [formControlName]="param.score_field_parameter_name"
                          [placeholder]="
                            'Enter ' + param.score_field_parameter_name
                          "
                          class="w-full min-w-[80px] border border-gray-300 rounded-md px-3 py-2 text-base bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        />
                      </ng-container>
                    </ng-template>

                    <div
                      *ngIf="
                        form.get(
                          'is' + getUniqueKey(subheading, i) + 'Selected'
                        )?.value &&
                        group.get(param.score_field_parameter_name)?.touched &&
                        group.get(param.score_field_parameter_name)?.invalid
                      "
                      class="text-red-600 text-xs mt-1"
                    >
                      <div
                        *ngIf="
                          group
                            .get(param.score_field_parameter_name)
                            ?.hasError('required')
                        "
                      >
                        {{ param.score_field_parameter_name }} is required.
                      </div>
                      <div
                        *ngIf="
                          group
                            .get(param.score_field_parameter_name)
                            ?.hasError('pattern')
                        "
                      >
                        Only alphabetic characters are allowed.
                      </div>
                      <div
                        *ngIf="
                          group
                            .get(param.score_field_parameter_name)
                            ?.hasError('min')
                        "
                      >
                        Value cannot be negative.
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>
